<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Order by Table</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              dark: '#323031',
              card: '#3d3b3c',
              text: '#7f7979',
              light: '#c1bdb3',
              accent: '#5f5b6b',
              gold: '#fbbf24'
            }
          }
        }
      }
    }
  </script>

<style>
  /* ===== Category Dropdown (details/summary) ===== */
  details.cat {
    overflow: hidden;
  }
  details.cat summary {
    list-style: none;
  }
  details.cat summary::-webkit-details-marker {
    display: none;
  }
  .chev {
    transition: transform .18s ease;
  }
  details[open] .chev {
    transform: rotate(180deg);
  }

  /* ===== nicer separators ===== */
  .divider-soft {
    border-top: 1px solid rgba(193,189,179,0.14);
  }

  /* ===== menu item hover ===== */
  .menu-row:hover {
    background: rgba(95, 91, 107, 0.18);
  }
</style>

</head>

<body class="antialiased overflow-x-hidden">
  <div id="loading">
    <div class="glass px-5 py-4 text-center">
      <div class="text-white font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
      <div class="text-xs text-brand-text mt-1">Order by Table</div>
    </div>
  </div>

  <div id="app" class="hidden container mx-auto px-4 py-6 max-w-md pb-28">
    <header class="flex items-center justify-between mb-4">
      <div>
        <div class="text-2xl font-extrabold text-white">üçú Order by Table</div>
        <div class="text-xs text-brand-text mt-1">
          <span id="modeLabel" class="badge chip bg-brand-card text-brand-light">CUSTOMER</span>
          <span class="ml-2" id="tableLabel"></span>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnRefresh" class="w-10 h-10 rounded-full glass flex items-center justify-center hover:bg-brand-accent/40">
          üîÑ
        </button>
        <button id="btnCart" class="w-10 h-10 rounded-full glass flex items-center justify-center hover:bg-brand-accent/40 relative">
          üß∫
          <span id="cartCount" class="absolute -top-2 -right-2 bg-brand-gold text-black text-[10px] font-bold rounded-full px-2 py-[1px] hidden">0</span>
        </button>
      </div>
    </header>

    <!-- CUSTOMER VIEW -->
    <div id="viewCustomer" class="space-y-3">
      <div class="glass p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-white font-bold">‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</div>
            <div class="text-xs text-brand-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π ‚Üí ‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ ‚Üí ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á</div>
          </div>
          <button id="btnMyOrders" class="text-xs underline text-brand-light hover:text-white">‡∏î‡∏π‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞</button>
        </div>

        <div class="mt-3">
          <input id="qMenu" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π..." class="w-full bg-brand-dark/50 border border-brand-text/30 rounded-lg p-3 text-white focus:outline-none" />
          <div class="mt-2 grid grid-cols-2 gap-2">
            <select id="filterCat" class="bg-brand-dark/50 border border-brand-text/30 rounded-lg p-3 text-white text-sm focus:outline-none">
                <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
            </select>
            <button id="btnCollapseAll" class="glass rounded-lg text-white font-bold text-sm active:scale-95">
                ‡∏û‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>
          </div>
        </div>
      </div>

      <div id="menuList" class="space-y-3"></div>
    </div>

    <!-- OWNER VIEW -->
    <div id="viewOwner" class="hidden space-y-3">
      <div class="glass p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-white font-bold">Owner Panel</div>
            <div class="text-xs text-brand-text">‡∏î‡∏π‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
          </div>
          <button id="btnOwnerLogout" class="text-xs underline text-brand-light hover:text-white">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î Owner</button>
        </div>

        <div class="grid grid-cols-2 gap-2 mt-3">
          <select id="ownerFilterStatus" class="bg-brand-dark/50 border border-brand-text/30 rounded-lg p-3 text-white text-sm focus:outline-none">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
            <option value="waiting">‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</option>
            <option value="cooking">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</option>
            <option value="done">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
            <option value="payment_wait">‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</option>
            <option value="paid">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</option>
            <option value="cancelled">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
          </select>
          <select id="ownerFilterTable" class="bg-brand-dark/50 border border-brand-text/30 rounded-lg p-3 text-white text-sm focus:outline-none">
            <option value="">‡∏ó‡∏∏‡∏Å‡πÇ‡∏ï‡πä‡∏∞</option>
          </select>
        </div>
      </div>

      <div id="ordersList" class="space-y-3"></div>
    </div>
  </div>

  <!-- MODAL: Add to Cart -->
  <div id="modalAdd" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4">
    <div class="glass p-5 w-full max-w-sm relative">
      <button class="absolute top-3 right-3 text-brand-text hover:text-white" onclick="closeModal('modalAdd')">‚úï</button>
      <div class="text-white font-bold text-lg" id="addTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</div>
      <div class="text-xs text-brand-text mt-1" id="addPriceLine"></div>

      <div class="mt-4 space-y-3">
        <div>
          <div class="text-sm text-brand-light mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</div>
          <div class="flex items-center gap-2">
            <button class="glass w-10 h-10 rounded-lg" onclick="addQty(-1)">-</button>
            <input id="addQty" type="number" min="1" value="1" class="w-full bg-brand-dark/50 border border-brand-text/30 rounded-lg p-3 text-white text-center" />
            <button class="glass w-10 h-10 rounded-lg" onclick="addQty(1)">+</button>
          </div>
        </div>

        <div>
          <div class="text-sm text-brand-light mb-2">‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ / ‡∏û‡∏¥‡πÄ‡∏®‡∏©</div>
          <div class="grid grid-cols-2 gap-2">
            <button id="btnSizeNormal" class="glass p-3 rounded-lg text-sm chip" onclick="setSize('normal')">‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤</button>
            <button id="btnSizeSpecial" class="glass p-3 rounded-lg text-sm chip" onclick="setSize('special')">‡∏û‡∏¥‡πÄ‡∏®‡∏©</button>
          </div>
        </div>

        <div>
          <div class="text-sm text-brand-light mb-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ú‡πá‡∏î</div>
          <select id="addSpice" class="w-full bg-brand-dark/50 border border-brand-text/30 rounded-lg p-3 text-white">
            <option value="none">‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î</option>
            <option value="less">‡πÄ‡∏ú‡πá‡∏î‡∏ô‡πâ‡∏≠‡∏¢</option>
            <option value="normal" selected>‡∏õ‡∏Å‡∏ï‡∏¥</option>
            <option value="more">‡πÄ‡∏ú‡πá‡∏î‡∏°‡∏≤‡∏Å</option>
            <option value="max">‡πÄ‡∏ú‡πá‡∏î‡∏™‡∏∏‡∏î</option>
          </select>
        </div>

        <div>
          <div class="text-sm text-brand-light mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div>
          <textarea id="addNote" rows="2" class="w-full bg-brand-dark/50 border border-brand-text/30 rounded-lg p-3 text-white" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏ú‡∏±‡∏Å / ‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°..."></textarea>
        </div>

        <button class="w-full bg-brand-gold text-black font-bold py-3 rounded-lg active:scale-95" onclick="confirmAddToCart()">
          ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL: Cart -->
  <div id="modalCart" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4">
    <div class="glass p-5 w-full max-w-sm relative max-h-[85vh] overflow-y-auto">
      <button class="absolute top-3 right-3 text-brand-text hover:text-white" onclick="closeModal('modalCart')">‚úï</button>
      <div class="text-white font-bold text-lg">üß∫ ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</div>
      <div class="text-xs text-brand-text mt-1" id="cartTableLine"></div>

      <div id="cartList" class="mt-4 space-y-2"></div>

      <div class="mt-4 border-t border-brand-text/20 pt-3">
        <div class="flex items-center justify-between text-sm">
          <span class="text-brand-text">‡∏£‡∏ß‡∏°</span>
          <span class="text-white font-bold" id="cartTotal">0</span>
        </div>

        <div class="mt-3">
          <textarea id="customerNote" rows="2" class="w-full bg-brand-dark/50 border border-brand-text/30 rounded-lg p-3 text-white" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
        </div>

        <button class="mt-3 w-full bg-brand-light text-black font-bold py-3 rounded-lg active:scale-95" onclick="submitOrder()">
          ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£
        </button>

        <button class="mt-2 w-full glass text-white font-bold py-3 rounded-lg active:scale-95" onclick="clearCart()">
          ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL: My Orders (Customer) -->
  <div id="modalMyOrders" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4">
    <div class="glass p-5 w-full max-w-sm relative max-h-[85vh] overflow-y-auto">
      <button class="absolute top-3 right-3 text-brand-text hover:text-white" onclick="closeModal('modalMyOrders')">‚úï</button>
      <div class="text-white font-bold text-lg">üìã ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞</div>
      <div class="text-xs text-brand-text mt-1" id="myOrdersLine"></div>

      <div id="myOrdersList" class="mt-4 space-y-3"></div>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    const SUPABASE_URL = "https://hqtqpxdkfcujgfbylwmp.supabase.co"; // Project uRL
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxdHFweGRrZmN1amdmYnlsd21wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMzMyMjAsImV4cCI6MjA4MTcwOTIyMH0.yV6RYDhgtWxtquZHdBAO7lQC68-DjE-HDvzNGKKARkY"; // anon public

    // Owner PIN (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏≠‡∏á)
    const OWNER_PIN = "1234";

    // ========= STATE =========
    let sb = null;
    let isOwner = false;
    let tableNo = null;

    let menuRows = [];
    let cart = []; // [{item_id,name,qty,size,spice,note,unit_price}]
    let addCtx = null; // {item}

    // ========= BOOT =========
    window.onload = async () => {
      sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      const params = new URLSearchParams(location.search);
      tableNo = params.get("table") ? Number(params.get("table")) : null;

      // owner mode
      if (params.get("owner") === "1") {
        await enterOwnerMode();
      } else {
        await enterCustomerMode();
      }

      document.getElementById("btnRefresh").onclick = () => refreshAll();
      document.getElementById("btnCart").onclick = () => openCart();
      document.getElementById("btnMyOrders").onclick = () => openMyOrders();

      document.getElementById("qMenu").addEventListener("input", () => renderMenu());

      hideLoading();
    };

    function hideLoading() {
      document.getElementById("loading").style.display = "none";
      document.getElementById("app").classList.remove("hidden");
    }

    async function refreshAll() {
      if (isOwner) {
        await loadOwnerFilters();
        await loadOrdersOwner();
      } else {
        await loadMenu();
        renderMenu();
        loadCartFromStorage();
        updateCartBadge();
      }
    }

    // ========= MODE =========
    async function enterCustomerMode() {
      isOwner = false;

      // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ table
      if (!tableNo || Number.isNaN(tableNo)) {
        await Swal.fire({
          icon: "warning",
          title: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞",
          text: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ö‡∏ö ?table=1 (‡∏à‡∏≤‡∏Å QR ‡∏ö‡∏ô‡πÇ‡∏ï‡πä‡∏∞)"
        });
      }

      document.getElementById("modeLabel").innerText = "CUSTOMER";
      document.getElementById("viewCustomer").classList.remove("hidden");
      document.getElementById("viewOwner").classList.add("hidden");
      document.getElementById("tableLabel").innerText = tableNo ? `‡πÇ‡∏ï‡πä‡∏∞: ${tableNo}` : "";

      loadCartFromStorage();
      updateCartBadge();

      await loadMenu();
      renderMenu();
    }

    async function enterOwnerMode() {
      isOwner = true;

      // PIN gate
      const saved = localStorage.getItem("owner_ok") === "1";
      if (!saved) {
        const { value } = await Swal.fire({
          title: "Owner PIN",
          input: "password",
          inputPlaceholder: "‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ PIN",
          confirmButtonText: "‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô",
          showCancelButton: true,
          cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
        });
        if (!value) {
          // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ customer mode (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ table ‡∏Å‡πá‡∏à‡∏∞‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏≠‡∏á)
          await enterCustomerMode();
          return;
        }
        if (String(value) !== OWNER_PIN) {
          await Swal.fire({ icon: "error", title: "PIN ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á" });
          await enterCustomerMode();
          return;
        }
        localStorage.setItem("owner_ok", "1");
      }

      document.getElementById("modeLabel").innerText = "OWNER";
      document.getElementById("viewCustomer").classList.add("hidden");
      document.getElementById("viewOwner").classList.remove("hidden");
      document.getElementById("tableLabel").innerText = "";

      document.getElementById("btnOwnerLogout").onclick = async () => {
        localStorage.removeItem("owner_ok");
        location.href = location.pathname; // ‡∏≠‡∏≠‡∏Å owner
      };

      document.getElementById("ownerFilterStatus").onchange = () => loadOrdersOwner();
      document.getElementById("ownerFilterTable").onchange = () => loadOrdersOwner();

      await loadOwnerFilters();
      await loadOrdersOwner();
    }

    // ========= MENU =========
    async function loadMenu() {
      const { data, error } = await sb
        .from("menu_items")
        .select("id,name,price_normal,price_special,is_active,sort_order, category:menu_categories(id,name,sort_order,is_active)")
        .eq("is_active", true)
        .order("sort_order", { ascending: true });

      if (error) {
        console.error(error);
        await Swal.fire("Error", error.message, "error");
        return;
      }

      menuRows = (data || []).map(r => ({
        ...r,
        cat_name: r.category?.name || "‡∏≠‡∏∑‡πà‡∏ô‡πÜ",
        cat_sort: r.category?.sort_order ?? 999
      })).sort((a,b) => (a.cat_sort - b.cat_sort) || (a.sort_order - b.sort_order) || (a.name.localeCompare(b.name)));
    }

    function renderMenu() {
        const q = (document.getElementById("qMenu").value || "").trim().toLowerCase();
        const selCat = (document.getElementById("filterCat")?.value || "").trim();

        let rows = menuRows || [];
        if (q) rows = rows.filter(r => (r.name || "").toLowerCase().includes(q));
        if (selCat) rows = rows.filter(r => (r.cat_name || "") === selCat);

        // group by category
        const groups = {};
        for (const r of rows) {
            const k = r.cat_name || "‡∏≠‡∏∑‡πà‡∏ô‡πÜ";
            if (!groups[k]) groups[k] = [];
            groups[k].push(r);
        }

        // build category dropdown options (‡∏à‡∏≤‡∏Å menuRows ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏ö)
        const allCats = Array.from(new Set((menuRows || []).map(r => r.cat_name || "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"))).sort((a,b)=>a.localeCompare(b));
        const catSel = document.getElementById("filterCat");
        if (catSel && catSel.dataset.inited !== "1") {
            catSel.innerHTML = `<option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>` + allCats.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
            catSel.dataset.inited = "1";
            catSel.onchange = () => renderMenu();
        }

        // collapse all toggle
        const btnCollapseAll = document.getElementById("btnCollapseAll");
        if (btnCollapseAll && btnCollapseAll.dataset.inited !== "1") {
            btnCollapseAll.dataset.inited = "1";
            btnCollapseAll.onclick = () => {
            const list = document.getElementById("menuList");
            const opened = list.querySelector("details[open]");
            const willClose = !!opened; // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà => ‡∏û‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            list.querySelectorAll("details.cat").forEach(d => {
                if (willClose) d.removeAttribute("open");
                else d.setAttribute("open", "open");
            });
            btnCollapseAll.innerText = willClose ? "‡∏Å‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" : "‡∏û‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
            };
        }

        const list = document.getElementById("menuList");
        list.innerHTML = "";

        const cats = Object.keys(groups);
        if (cats.length === 0) {
            list.innerHTML = `<div class="glass p-4 text-center text-brand-text">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π</div>`;
            return;
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠ (‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÉ‡∏ä‡πâ sort_order ‡∏Å‡πá‡πÑ‡∏î‡πâ)
        cats.sort((a,b)=>a.localeCompare(b));

        cats.forEach((cat, idx) => {
            const key = hashKey(cat);
            const count = groups[cat].length;

            // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏°‡∏ß‡∏î‡πÅ‡∏£‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            const openAttr = (idx === 0 && !selCat) ? "open" : (selCat ? "open" : "");

            list.innerHTML += `
            <details class="cat glass p-4" ${openAttr}>
                <summary class="flex items-center justify-between cursor-pointer select-none">
                <div class="min-w-0">
                    <div class="text-white font-bold truncate">${escapeHtml(cat)}</div>
                    <div class="text-[11px] text-brand-text mt-0.5">${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-[10px] px-2 py-1 rounded-full bg-brand-dark/40 border border-brand-text/20 text-brand-light">
                    ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π
                    </span>
                    <span class="chev text-brand-light">‚åÑ</span>
                </div>
                </summary>

                <div class="divider-soft my-3"></div>
                <div class="space-y-2" id="cat-${key}"></div>
            </details>
            `;

            const box = document.getElementById(`cat-${key}`);
            groups[cat].forEach(it => {
            box.innerHTML += `
                <div class="menu-row flex items-center justify-between gap-3 p-3 rounded-xl bg-brand-dark/35 border border-brand-text/15 transition">
                <div class="min-w-0">
                    <div class="text-white font-semibold truncate">${escapeHtml(it.name)}</div>
                    <div class="text-xs text-brand-text mt-1 flex items-center gap-2 flex-wrap">
                    <span class="px-2 py-1 rounded-full bg-brand-dark/40 border border-brand-text/15">
                        ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤: <b class="text-brand-light">${fmt(it.price_normal)}</b>
                    </span>
                    <span class="px-2 py-1 rounded-full bg-brand-dark/40 border border-brand-text/15">
                        ‡∏û‡∏¥‡πÄ‡∏®‡∏©: <b class="text-brand-light">${fmt(it.price_special)}</b>
                    </span>
                    </div>
                </div>

                <button
                    class="bg-brand-gold text-black font-extrabold px-4 py-2.5 rounded-xl text-sm active:scale-95 shadow-lg shadow-black/20"
                    onclick="openAddModal(${it.id})"
                    title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤"
                >
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°
                </button>
                </div>
            `;
            });
        });

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏±‡∏ö/‡∏Å‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        if (btnCollapseAll) {
            const anyOpen = !!document.querySelector("#menuList details.cat[open]");
            btnCollapseAll.innerText = anyOpen ? "‡∏û‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" : "‡∏Å‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
        }
    }

    function openAddModal(itemId) {
      const it = menuRows.find(x => x.id === itemId);
      if (!it) return;

      addCtx = { item: it };

      document.getElementById("addTitle").innerText = it.name;
      document.getElementById("addQty").value = 1;
      document.getElementById("addSpice").value = "normal";
      document.getElementById("addNote").value = "";

      document.getElementById("addPriceLine").innerHTML = `
        ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ <b class="text-brand-light">${fmt(it.price_normal)}</b>
        <span class="mx-2 text-brand-text/50">|</span>
        ‡∏û‡∏¥‡πÄ‡∏®‡∏© <b class="text-brand-light">${fmt(it.price_special)}</b>
      `;

      setSize("normal");
      openModal("modalAdd");
    }

    function addQty(d) {
      const el = document.getElementById("addQty");
      let v = Number(el.value || 1);
      v = v + d;
      if (v < 1) v = 1;
      el.value = v;
    }

    function setSize(s) {
      const n = document.getElementById("btnSizeNormal");
      const p = document.getElementById("btnSizeSpecial");
      if (s === "normal") {
        n.classList.add("bg-brand-accent/40");
        p.classList.remove("bg-brand-accent/40");
      } else {
        p.classList.add("bg-brand-accent/40");
        n.classList.remove("bg-brand-accent/40");
      }
      addCtx.size = s;
    }

    function confirmAddToCart() {
      if (!addCtx?.item) return;

      const it = addCtx.item;
      const qty = Math.max(1, Number(document.getElementById("addQty").value || 1));
      const size = addCtx.size || "normal";
      const spice = document.getElementById("addSpice").value || "normal";
      const note = (document.getElementById("addNote").value || "").trim();

      const unit_price = (size === "special") ? Number(it.price_special || 0) : Number(it.price_normal || 0);

      cart.push({
        item_id: it.id,
        item_name: it.name,
        qty,
        size,
        spice,
        note,
        unit_price
      });

      saveCartToStorage();
      updateCartBadge();
      closeModal("modalAdd");

      Swal.fire({ toast:true, position:"top-end", timer:1500, showConfirmButton:false, icon:"success", title:"‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß" });
    }

    // ========= CART =========
    function cartKey() {
      return `cart_table_${tableNo || "unknown"}`;
    }

    function loadCartFromStorage() {
      try {
        cart = JSON.parse(localStorage.getItem(cartKey()) || "[]") || [];
      } catch {
        cart = [];
      }
    }

    function saveCartToStorage() {
      localStorage.setItem(cartKey(), JSON.stringify(cart || []));
    }

    function updateCartBadge() {
      const n = (cart || []).reduce((s,x) => s + Number(x.qty || 0), 0);
      const badge = document.getElementById("cartCount");
      if (n > 0) {
        badge.innerText = String(n);
        badge.classList.remove("hidden");
      } else {
        badge.classList.add("hidden");
      }
    }

    function openCart() {
      if (!tableNo) {
        Swal.fire("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å QR ‡∏ö‡∏ô‡πÇ‡∏ï‡πä‡∏∞ (?table=1)", "warning");
        return;
      }
      loadCartFromStorage();
      renderCart();
      document.getElementById("cartTableLine").innerText = `‡πÇ‡∏ï‡πä‡∏∞: ${tableNo}`;
      openModal("modalCart");
    }

    function renderCart() {
      const box = document.getElementById("cartList");
      box.innerHTML = "";

      if (!cart || cart.length === 0) {
        box.innerHTML = `<div class="text-center text-brand-text py-8">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á</div>`;
        document.getElementById("cartTotal").innerText = fmt(0);
        return;
      }

      cart.forEach((x, idx) => {
        box.innerHTML += `
          <div class="p-3 rounded-lg bg-brand-dark/40 border border-brand-text/15">
            <div class="flex items-start justify-between gap-2">
              <div class="min-w-0">
                <div class="text-white font-semibold truncate">${escapeHtml(x.item_name)}</div>
                <div class="text-xs text-brand-text mt-1">
                  ${x.size === "special" ? "‡∏û‡∏¥‡πÄ‡∏®‡∏©" : "‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤"} ‚Ä¢
                  ${spiceLabel(x.spice)}
                  ${x.note ? `‚Ä¢ <span class="text-brand-light">${escapeHtml(x.note)}</span>` : ""}
                </div>
                <div class="text-xs text-brand-text mt-1">
                  ‡∏£‡∏≤‡∏Ñ‡∏≤: <span class="text-brand-light font-bold">${fmt(x.unit_price)}</span>
                </div>
              </div>
              <button class="text-xs underline text-brand-light hover:text-white" onclick="removeCartItem(${idx})">‡∏•‡∏ö</button>
            </div>

            <div class="flex items-center justify-between mt-2">
              <div class="flex items-center gap-2">
                <button class="glass w-9 h-9 rounded-lg" onclick="changeCartQty(${idx},-1)">-</button>
                <div class="w-12 text-center text-white font-bold">${x.qty}</div>
                <button class="glass w-9 h-9 rounded-lg" onclick="changeCartQty(${idx},1)">+</button>
              </div>
              <div class="text-white font-bold">${fmt(Number(x.qty)*Number(x.unit_price))}</div>
            </div>
          </div>
        `;
      });

      const total = cart.reduce((s,x) => s + Number(x.qty||0)*Number(x.unit_price||0), 0);
      document.getElementById("cartTotal").innerText = fmt(total);
    }

    function removeCartItem(i) {
      cart.splice(i,1);
      saveCartToStorage();
      updateCartBadge();
      renderCart();
    }

    function changeCartQty(i, d) {
      const x = cart[i];
      if (!x) return;
      x.qty = Math.max(1, Number(x.qty || 1) + d);
      saveCartToStorage();
      updateCartBadge();
      renderCart();
    }

    async function clearCart() {
      cart = [];
      saveCartToStorage();
      updateCartBadge();
      renderCart();
    }

    // ========= SUBMIT ORDER =========
    async function submitOrder() {
      if (!tableNo) return;
      loadCartFromStorage();
      if (!cart || cart.length === 0) {
        Swal.fire("‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á", "", "warning");
        return;
      }

      const note = (document.getElementById("customerNote").value || "").trim();

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á order
      const { data: orderRow, error: oErr } = await sb
        .from("orders")
        .insert({
          table_no: tableNo,
          status: "waiting",
          customer_note: note
        })
        .select()
        .single();

      if (oErr) {
        console.error(oErr);
        Swal.fire("Error", oErr.message, "error");
        return;
      }

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á items
      const payload = cart.map(x => ({
        order_id: orderRow.id,
        item_id: x.item_id,
        item_name: x.item_name,
        qty: x.qty,
        size: x.size,
        spice: x.spice,
        note: x.note || null,
        unit_price: x.unit_price
      }));

      const { error: iErr } = await sb.from("order_items").insert(payload);
      if (iErr) {
        console.error(iErr);
        Swal.fire("Error", iErr.message, "error");
        return;
      }

      // ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
      await clearCart();
      closeModal("modalCart");

      Swal.fire({
        icon: "success",
        title: "‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß",
        html: `Order: <b>${orderRow.id}</b><br>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <b>‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</b>`
      });

      // ‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      openMyOrders();
    }

    // ========= CUSTOMER: MY ORDERS =========
    async function openMyOrders() {
      if (!tableNo) {
        Swal.fire("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å QR ‡∏ö‡∏ô‡πÇ‡∏ï‡πä‡∏∞ (?table=1)", "warning");
        return;
      }
      document.getElementById("myOrdersLine").innerText = `‡πÇ‡∏ï‡πä‡∏∞: ${tableNo}`;
      openModal("modalMyOrders");
      await loadMyOrders();
    }

    async function loadMyOrders() {
      const { data: orders, error } = await sb
        .from("orders")
        .select("id,table_no,status,customer_note,created_at,updated_at, order_items(id,item_name,qty,size,spice,note,unit_price)")
        .eq("table_no", tableNo)
        .order("created_at", { ascending: false })
        .limit(30);

      if (error) {
        console.error(error);
        document.getElementById("myOrdersList").innerHTML = `<div class="text-red-400">${escapeHtml(error.message)}</div>`;
        return;
      }

      const box = document.getElementById("myOrdersList");
      box.innerHTML = "";

      if (!orders || orders.length === 0) {
        box.innerHTML = `<div class="text-center text-brand-text py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>`;
        return;
      }

      for (const o of orders) {
        const items = o.order_items || [];
        const sum = items.reduce((s,x)=> s + Number(x.qty||0)*Number(x.unit_price||0), 0);

        box.innerHTML += `
          <div class="glass p-4">
            <div class="flex items-start justify-between">
              <div>
                <div class="text-white font-bold text-sm">Order</div>
                <div class="text-xs text-brand-text break-all">${o.id}</div>
                <div class="text-xs text-brand-text mt-1">${fmtDate(o.created_at)}</div>
              </div>
              <div class="badge ${statusClass(o.status)}">${statusLabel(o.status)}</div>
            </div>

            ${o.customer_note ? `<div class="text-xs text-brand-text mt-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: <span class="text-brand-light">${escapeHtml(o.customer_note)}</span></div>` : ""}

            <div class="mt-3 space-y-1">
              ${items.map(x => `
                <div class="text-sm text-brand-light flex justify-between gap-2">
                  <div class="min-w-0 truncate">
                    ${escapeHtml(x.item_name)} √ó ${x.qty}
                    <span class="text-xs text-brand-text">(${x.size === "special" ? "‡∏û‡∏¥‡πÄ‡∏®‡∏©" : "‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤"} ‚Ä¢ ${spiceLabel(x.spice)})</span>
                    ${x.note ? `<span class="text-xs text-brand-text">‚Ä¢ ${escapeHtml(x.note)}</span>` : ""}
                  </div>
                  <div class="text-white font-bold">${fmt(Number(x.qty)*Number(x.unit_price))}</div>
                </div>
              `).join("")}
            </div>

            <div class="mt-3 flex items-center justify-between border-t border-brand-text/20 pt-3">
              <div class="text-xs text-brand-text">‡∏£‡∏ß‡∏°</div>
              <div class="text-white font-extrabold">${fmt(sum)}</div>
            </div>
          </div>
        `;
      }
    }

    // ========= OWNER =========
    async function loadOwnerFilters() {
      // tables dropdown
      const { data: tables } = await sb
        .from("restaurant_tables")
        .select("table_no,table_name,is_active")
        .eq("is_active", true)
        .order("table_no", { ascending: true });

      const sel = document.getElementById("ownerFilterTable");
      sel.innerHTML = `<option value="">‡∏ó‡∏∏‡∏Å‡πÇ‡∏ï‡πä‡∏∞</option>`;
      (tables || []).forEach(t => {
        sel.innerHTML += `<option value="${t.table_no}">‡πÇ‡∏ï‡πä‡∏∞ ${t.table_no}</option>`;
      });
    }

    async function loadOrdersOwner() {
      const st = document.getElementById("ownerFilterStatus").value || "";
      const tb = document.getElementById("ownerFilterTable").value || "";

      let q = sb
        .from("orders")
        .select("id,table_no,status,customer_note,created_at,updated_at, order_items(id,item_name,qty,size,spice,note,unit_price)")
        .order("created_at", { ascending: false })
        .limit(80);

      if (st) q = q.eq("status", st);
      if (tb) q = q.eq("table_no", Number(tb));

      const { data: orders, error } = await q;

      const box = document.getElementById("ordersList");
      box.innerHTML = "";

      if (error) {
        console.error(error);
        box.innerHTML = `<div class="text-red-400">${escapeHtml(error.message)}</div>`;
        return;
      }

      if (!orders || orders.length === 0) {
        box.innerHTML = `<div class="glass p-4 text-center text-brand-text">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>`;
        return;
      }

      for (const o of orders) {
        const items = o.order_items || [];
        const sum = items.reduce((s,x)=> s + Number(x.qty||0)*Number(x.unit_price||0), 0);

        box.innerHTML += `
          <div class="glass p-4">
            <div class="flex items-start justify-between">
              <div>
                <div class="text-white font-extrabold">‡πÇ‡∏ï‡πä‡∏∞ ${o.table_no}</div>
                <div class="text-xs text-brand-text mt-1">${fmtDate(o.created_at)}</div>
                <div class="text-xs text-brand-text break-all mt-1">${o.id}</div>
              </div>
              <div class="badge ${statusClass(o.status)}">${statusLabel(o.status)}</div>
            </div>

            ${o.customer_note ? `<div class="text-xs text-brand-text mt-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: <span class="text-brand-light">${escapeHtml(o.customer_note)}</span></div>` : ""}

            <div class="mt-3 space-y-1">
              ${items.map(x => `
                <div class="text-sm text-brand-light flex justify-between gap-2">
                  <div class="min-w-0 truncate">
                    ${escapeHtml(x.item_name)} √ó ${x.qty}
                    <span class="text-xs text-brand-text">(${x.size === "special" ? "‡∏û‡∏¥‡πÄ‡∏®‡∏©" : "‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤"} ‚Ä¢ ${spiceLabel(x.spice)})</span>
                    ${x.note ? `<span class="text-xs text-brand-text">‚Ä¢ ${escapeHtml(x.note)}</span>` : ""}
                  </div>
                  <div class="text-white font-bold">${fmt(Number(x.qty)*Number(x.unit_price))}</div>
                </div>
              `).join("")}
            </div>

            <div class="mt-3 flex items-center justify-between border-t border-brand-text/20 pt-3">
              <div class="text-xs text-brand-text">‡∏£‡∏ß‡∏°</div>
              <div class="text-white font-extrabold">${fmt(sum)}</div>
            </div>

            <div class="grid grid-cols-2 gap-2 mt-3">
              <button class="glass py-3 rounded-lg font-bold text-white active:scale-95" onclick="setOrderStatus('${o.id}','waiting')">‡∏£‡∏≠‡∏£‡∏±‡∏ö</button>
              <button class="glass py-3 rounded-lg font-bold text-white active:scale-95" onclick="setOrderStatus('${o.id}','cooking')">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</button>
              <button class="glass py-3 rounded-lg font-bold text-white active:scale-95" onclick="setOrderStatus('${o.id}','done')">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
              <button class="glass py-3 rounded-lg font-bold text-white active:scale-95" onclick="setOrderStatus('${o.id}','payment_wait')">‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞</button>
              <button class="glass py-3 rounded-lg font-bold text-white active:scale-95 col-span-2" onclick="setOrderStatus('${o.id}','paid')">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</button>
              <button class="text-xs underline text-red-300 hover:text-red-200 col-span-2" onclick="setOrderStatus('${o.id}','cancelled')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
            </div>
          </div>
        `;
      }
    }

    async function setOrderStatus(orderId, status) {
      const ok = await Swal.fire({
        icon: "question",
        title: "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞?",
        html: `Order: <b>${orderId}</b><br>‚Üí <b>${statusLabel(status)}</b>`,
        showCancelButton: true,
        confirmButtonText: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô",
        cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
      });
      if (!ok.isConfirmed) return;

      const { error } = await sb.from("orders").update({ status }).eq("id", orderId);
      if (error) {
        console.error(error);
        Swal.fire("Error", error.message, "error");
        return;
      }
      Swal.fire({ toast:true, position:"top-end", timer:1200, showConfirmButton:false, icon:"success", title:"‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß" });
      await loadOrdersOwner();
    }

    // ========= UI HELPERS =========
    function openModal(id) {
      const el = document.getElementById(id);
      el.classList.remove("hidden");
      el.classList.add("flex");
    }
    function closeModal(id) {
      const el = document.getElementById(id);
      el.classList.add("hidden");
      el.classList.remove("flex");
    }

    function fmt(n) {
      const v = Number(n || 0);
      return v.toLocaleString("th-TH", { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + " ‡∏ø";
    }
    function fmtDate(dt) {
      try {
        return new Date(dt).toLocaleString("th-TH", { year:"numeric", month:"short", day:"numeric", hour:"2-digit", minute:"2-digit" });
      } catch {
        return String(dt || "");
      }
    }
    function spiceLabel(s) {
      const map = { none:"‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î", less:"‡πÄ‡∏ú‡πá‡∏î‡∏ô‡πâ‡∏≠‡∏¢", normal:"‡∏õ‡∏Å‡∏ï‡∏¥", more:"‡πÄ‡∏ú‡πá‡∏î‡∏°‡∏≤‡∏Å", max:"‡πÄ‡∏ú‡πá‡∏î‡∏™‡∏∏‡∏î" };
      return map[s] || s || "‡∏õ‡∏Å‡∏ï‡∏¥";
    }
    function statusLabel(s) {
      const map = {
        waiting:"‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå",
        cooking:"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥",
        done:"‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô",
        payment_wait:"‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô",
        paid:"‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß",
        cancelled:"‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
      };
      return map[s] || s;
    }
    function statusClass(s) {
      const map = {
        waiting:"st-waiting",
        cooking:"st-cooking",
        done:"st-done",
        payment_wait:"st-payment_wait",
        paid:"st-paid",
        cancelled:"st-cancelled"
      };
      return map[s] || "st-waiting";
    }
    function escapeHtml(s) {
      return String(s ?? "").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    }
    function hashKey(s) {
      let h = 0;
      const str = String(s || "");
      for (let i=0;i<str.length;i++) h = ((h<<5)-h)+str.charCodeAt(i), h|=0;
      return "k"+Math.abs(h);
    }
  </script>
</body>
</html>
